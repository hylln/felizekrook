---
import Layout from "../layouts/Layout.astro";
import { Image } from "astro:assets";

//IMPORT IMAGES FROM ASSETS FOLDER
import angelsong from "../assets/angelsong.mp3";
import img1 from "../assets/1.jpeg";
import img2 from "../assets/2.jpeg";
import img3 from "../assets/3.jpeg";
import img4 from "../assets/4.jpeg";
import img5 from "../assets/5.jpeg";
import img6 from "../assets/6.jpeg";
import img7 from "../assets/7.jpeg";
import img8 from "../assets/8.jpeg";
import img9 from "../assets/9.jpeg";

//ADDS THE IMAGES TO THE PROJECTS ARRAY
const projects = [
	{ id: "01", title: "SKETCHES", img: img2 },
	{ id: "02", title: "PANTHER", img: img1 },
	{ id: "03", title: "SKETCHES 2", img: img4 },
	{ id: "04", title: "FELIZE", img: img5 },
	{ id: "05", title: "BALENCIAGA", img: img6 },
	{ id: "06", title: "CHANEL", img: img3 },
	{ id: "07", title: "BLUE", img: img7 },
	{ id: "08", title: "FOOTBALL", img: img8 },
	{ id: "09", title: "FUNNY", img: img9 },
];
---

<Layout title="HOME">
	<svg
		style="position: absolute; width: 0; height: 0;"
		aria-hidden="true"
		focusable="false"
	>
		<filter id="cyber-glitch">
			<feTurbulence
				type="fractalNoise"
				baseFrequency="0.01 0.2"
				numOctaves="3"
				result="noise"></feTurbulence>
			<feDisplacementMap in="SourceGraphic" in2="noise" scale="10"
			></feDisplacementMap>
		</filter>
	</svg>

	<header class="hero">
		<a href="/" class="logo-link">
			<h1>FELIZE KROOK</h1>
		</a>
		<nav class="header-nav">
			<a href="/gallery">GALLERY</a>
			<a href="/about">ABOUT</a>
			<a href="/contact">CONTACT</a>
		</nav>
	</header>

	<main class="main-content" id="scroll-container">
		<section class="centered-gallery">
			<div class="project-card landing-card" id="landing-trigger">
				<div class="video-background" id="video-wrapper">
					<audio id="bg-music" loop>
						<source src={angelsong} type="audio/mpeg" />
					</audio>

					<div id="playback-status" class="playback-status">
						<svg
							class="pause-icon"
							width="10"
							height="10"
							viewBox="0 0 10 10"
						>
							<rect
								x="1"
								y="0"
								width="1.5"
								height="10"
								fill="white"></rect>
							<rect
								x="7.5"
								y="0"
								width="1.5"
								height="10"
								fill="white"></rect>
						</svg>
						<svg
							class="play-icon"
							width="10"
							height="10"
							viewBox="0 0 10 10"
						>
							<polygon points="0,0 10,5 0,10" fill="white"
							></polygon>
						</svg>
					</div>

					<div class="audio-controls-group">
						<div class="volume-slider-wrapper">
							<input
								type="range"
								id="volume-slider"
								min="0"
								max="1"
								step="0.01"
								value="1"
							/>
						</div>
						<button id="audio-toggle" class="audio-toggle-overlay">
							<svg
								class="speaker-on-icon"
								width="14"
								height="14"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
								stroke-linecap="round"
								stroke-linejoin="round"
							>
								<polygon
									points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"
								></polygon>
								<path
									d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"
								></path>
							</svg>
							<svg
								class="speaker-off-icon"
								width="14"
								height="14"
								viewBox="0 0 24 24"
								fill="none"
								stroke="currentColor"
								stroke-width="2"
								stroke-linecap="round"
								stroke-linejoin="round"
							>
								<polygon
									points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"
								></polygon>
								<line x1="23" y1="9" x2="17" y2="15"></line>
								<line x1="17" y1="9" x2="23" y2="15"></line>
							</svg>
						</button>
					</div>

					<video
						autoplay
						muted
						playsinline
						id="bg-video-1"
						class="bg-video is-active"
					>
						<source src="/clouds.mp4" type="video/mp4" />
					</video>
					<video muted playsinline id="bg-video-2" class="bg-video">
						<source src="/mountains.mp4" type="video/mp4" />
					</video>
					<video muted playsinline id="bg-video-3" class="bg-video">
						<source src="/waves.mp4" type="video/mp4" />
					</video>

					<div class="video-overlay" id="glitch-overlay"></div>
					<div class="scroll-fade-overlay" id="scroll-fade"></div>
				</div>

				<div class="landing-content" id="landing-text-wrapper">
					<p class="landing-label">
						PORTFOLIO<br />SHOWCASE<br />2026
					</p>
					<div class="scroll-to-continue scroll-trigger">
						SCROLL TO CONTINUE
					</div>
					<div class="landing-arrow-container">
						<div class="arrow-indicator down-arrow scroll-trigger">
							<svg
								viewBox="0 0 20 100"
								preserveAspectRatio="none"
							>
								<line
									x1="10"
									y1="0"
									x2="10"
									y2="100"
									stroke="white"
									stroke-width="0.8"></line>
								<polyline
									points="4,96 10,100 16,96"
									fill="none"
									stroke="white"
									stroke-width="0.8"></polyline>
							</svg>
						</div>
					</div>
				</div>
			</div>

			{
				projects.map((project) => (
					<div class="project-card first-hero">
						<div class="image-container">
							<Image
								src={project.img}
								alt={project.title}
								class="zoom-img"
								quality="high"
								format="webp"
							/>
							<div class="details">
								<span>{project.id}</span> {project.title}
							</div>
						</div>
					</div>
				))
			}

			<div class="project-card footer-card">
				<div class="footer-content">
					<p class="footer-label">INQUIRIES</p>
					<a
						href="mailto:FELIZE.KROOK1@GMAIL.COM"
						class="footer-email">FELIZE.KROOK1@GMAIL.COM</a
					>
					<div class="footer-links">
						<a
							href="https://instagram.com/felizekrook"
							target="_blank">INSTAGRAM</a
						>
						<a href="/about">ABOUT</a>
					</div>
					<button id="back-to-top" class="back-to-top-text"
						>BACK TO TOP</button
					>
				</div>
			</div>
		</section>
	</main>

	<div id="lightbox" class="lightbox">
		<span class="close-lightbox" id="close-btn">&times;</span>
		<div class="lightbox-content-wrapper" id="lightbox-wrapper">
			<img
				class="lightbox-content"
				id="lightbox-img"
				alt="Fullscreen View"
			/>
		</div>
	</div>

	<style>
		:global(body) {
			margin: 0;
			overflow: hidden;
			background-color: #fff;
			font-family: sans-serif;
			-webkit-text-size-adjust: 100%;
		}
		.main-content {
			width: 100%;
			height: 100vh;
			overflow-y: scroll;
			scroll-snap-type: y mandatory;
		}
		.hero {
			text-align: center;
			position: fixed;
			width: 100%;
			top: 0;
			z-index: 1000;
			background-color: #ffffff;
			padding: 2rem 2rem;
			border-bottom: 1px solid rgba(0, 0, 0, 0.2);
			display: flex;
			justify-content: center;
			align-items: center;
			box-sizing: border-box;
		}
		h1 {
			font-size: clamp(1rem, 2vw, 12rem);
			line-height: 0.85;
			letter-spacing: -0.05em;
			text-transform: uppercase;
			margin: 0;
			color: #000;
		}
		.logo-link {
			text-decoration: none;
			color: inherit;
			display: inline-block;
			transition: opacity 0.3s ease;
		}
		.logo-link:hover {
			opacity: 0.6;
		}
		.header-nav {
			position: absolute;
			right: 2rem;
			display: flex;
			gap: 1.5rem;
		}
		.header-nav a {
			font-size: 0.7rem;
			text-decoration: none;
			color: #000;
			letter-spacing: 0.05em;
			text-transform: uppercase;
			transition: opacity 0.3s ease;
		}
		.header-nav a:hover {
			opacity: 0.6;
		}

		.landing-card {
			position: relative;
			overflow: hidden;
			background-color: #000;
		}
		.video-background {
			opacity: 0;
			transition: opacity 1.5s ease-in-out;
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 1;
			pointer-events: none;
		}
		.landing-content {
			opacity: 0;
			z-index: 10;
			text-align: center;
			color: #fff;
			pointer-events: none;
			width: 100%;
			transition:
				opacity 1.5s ease-in-out,
				color 0.1s steps(2);
		}
		.scroll-trigger {
			cursor: pointer;
			pointer-events: auto;
			transition: opacity 0.3s ease;
			width: fit-content;
			margin: 0 auto;
		}
		.scroll-trigger:hover {
			opacity: 0.6;
		}
		.is-visible {
			opacity: 1 !important;
		}
		.bg-video {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			object-fit: cover;
			opacity: 0;
		}
		.bg-video.is-active {
			opacity: 1;
			z-index: 2;
		}

		.audio-controls-group {
			position: absolute;
			top: 130px;
			right: 2rem;
			z-index: 100;
			display: flex;
			align-items: center;
			pointer-events: auto;
			transition: opacity 0.3s ease;
		}
		.audio-toggle-overlay {
			background: none;
			border: none;
			padding: 10px;
			cursor: pointer;
			color: #fff;
			display: flex;
			align-items: center;
			justify-content: center;
			transition:
				opacity 0.3s ease,
				color 0.1s steps(2);
		}
		.audio-toggle-overlay:hover {
			opacity: 0.6;
		}
		.audio-toggle-overlay .speaker-on-icon {
			display: none;
		}
		.audio-toggle-overlay.is-playing .speaker-on-icon {
			display: block;
		}
		.audio-toggle-overlay.is-playing .speaker-off-icon {
			display: none;
		}
		.audio-controls-group.is-dark {
			color: #000;
		}
		.audio-controls-group.is-dark .audio-toggle-overlay {
			color: #000;
		}

		.volume-slider-wrapper {
			width: 0;
			overflow: hidden;
			transition:
				width 0.3s ease,
				opacity 0.3s ease;
			opacity: 0;
			display: flex;
			align-items: center;
		}
		.audio-controls-group:hover .volume-slider-wrapper {
			width: 80px;
			opacity: 1;
			margin-right: 4px;
		}
		#volume-slider {
			width: 70px;
			cursor: pointer;
			accent-color: currentColor;
		}

		.video-glitch {
			filter: url(#cyber-glitch) contrast(1.2) brightness(1.1);
			animation: glitch-switch 0.1s steps(2) infinite;
		}
		@keyframes glitch-switch {
			0% {
				transform: scale(1) skew(0deg);
				filter: hue-rotate(0deg) contrast(1.2);
			}
			50% {
				transform: scale(1.02) skew(2deg) translateX(5px);
				filter: hue-rotate(180deg) brightness(1.5);
			}
			100% {
				transform: scale(0.98) skew(-2deg) translateX(-5px);
				filter: hue-rotate(0deg) contrast(1.2);
			}
		}
		.text-glitch {
			filter: url(#cyber-glitch);
			transform: translateX(2px);
		}

		.text-glitch-h {
			/* Horizontal */
			filter: url(#cyber-glitch);
			transform: translateX(10px) skewX(5deg);
		}

		.text-glitch-v {
			/* Vertical */
			filter: url(#cyber-glitch);
			transform: translateY(-5px) scaleY(1.1);
		}

		.text-glitch-color {
			/* Color Split/Intensity */
			filter: url(#cyber-glitch) saturate(5) contrast(2);
			text-shadow:
				2px 0 red,
				-2px 0 blue;
		}

		.video-overlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: linear-gradient(
				rgba(18, 16, 16, 0) 50%,
				rgba(0, 0, 0, 0.1) 50%
			);
			background-size: 100% 2px;
			z-index: 5;
			pointer-events: none;
		}
		.scroll-fade-overlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: #000;
			opacity: 0;
			z-index: 6;
			pointer-events: none;
		}
		.playback-status {
			position: absolute;
			top: 130px;
			left: 2rem;
			z-index: 100;
			opacity: 1;
			cursor: pointer;
			transition:
				opacity 0.3s ease,
				color 0.1s steps(2);
			display: flex;
			align-items: center;
			pointer-events: auto;
			padding: 10px;
		}
		.playback-status:hover {
			opacity: 0.6;
		}
		.playback-status.is-paused .pause-icon {
			display: none;
		}
		.playback-status:not(.is-paused) .play-icon {
			display: none;
		}
		.playback-status.is-paused .play-icon {
			display: block;
		}
		.landing-content.is-dark {
			color: #000;
		}
		.landing-content.is-dark .arrow-indicator svg line,
		.landing-content.is-dark .arrow-indicator svg polyline {
			stroke: #000;
		}
		.playback-status.is-dark svg rect,
		.playback-status.is-dark svg polygon {
			fill: #000;
			transition: fill 0.1s steps(2);
		}

		.landing-arrow-container {
			margin-top: 2rem;
			height: 15vh;
			display: flex;
			justify-content: center;
		}
		.arrow-indicator {
			position: relative;
			height: 100%;
			width: 20px;
		}

		.project-card {
			width: 100%;
			height: 100vh;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
			scroll-snap-align: center;
			padding: 0 2rem;
			box-sizing: border-box;
			position: relative;
			scroll-margin-top: 100px;
		}
		.image-container {
			position: relative;
			width: fit-content;
			max-width: 600px;
		}
		.zoom-img {
			width: auto;
			max-width: 100%;
			height: auto;
			max-height: 65vh;
			object-fit: contain;
			cursor: zoom-in;
			transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
		}
		.zoom-img:hover {
			transform: scale(1.05);
		}
		.details {
			display: flex;
			justify-content: space-between;
			margin-top: 1.5rem;
			font-size: 0.7rem;
			text-transform: uppercase;
			letter-spacing: 0.1em;
			width: 100%;
		}
		.footer-content {
			text-align: center;
			width: 100%;
			max-width: 800px;
			display: flex;
			flex-direction: column;
			align-items: center;
		}
		.footer-label {
			font-size: 0.6rem;
			letter-spacing: 0.2em;
			margin-bottom: 1.5rem;
			text-transform: uppercase;
			color: #000;
		}
		.footer-email {
			font-size: clamp(1rem, 2.5vw, 2.2rem);
			text-decoration: none;
			color: #000;
			display: block;
			margin-bottom: 3.5rem;
			transition: opacity 0.6s ease;
		}
		.footer-email:hover {
			opacity: 0.6;
		}
		.footer-links {
			display: flex;
			justify-content: center;
			gap: 2.5rem;
			margin-bottom: 4rem;
		}
		.footer-links a {
			font-size: 0.7rem;
			text-decoration: none;
			color: #000;
			letter-spacing: 0.1em;
			transition: opacity 0.2s ease;
		}
		.back-to-top-text {
			background: none;
			border: none;
			padding: 0;
			cursor: pointer;
			font-size: 0.7rem;
			letter-spacing: 0.1em;
			text-transform: uppercase;
			color: #000 !important;
			transition: opacity 0.2s ease;
		}

		.lightbox {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 3000;
			display: flex;
			justify-content: center;
			align-items: center;
			background-color: rgba(255, 255, 255, 0.6);
			backdrop-filter: blur(2px);
			opacity: 0;
			visibility: hidden;
			pointer-events: none;
			transition:
				opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1),
				visibility 0.6s cubic-bezier(0.4, 0, 0.2, 1);
			touch-action: none;
		}
		.lightbox.show {
			opacity: 1;
			visibility: visible;
			pointer-events: auto;
		}
		.close-lightbox {
			position: absolute;
			top: 2rem;
			right: 2rem;
			font-size: 2.5rem;
			z-index: 4000;
			cursor: pointer;
			color: #000;
			line-height: 1;
		}
		.lightbox-content-wrapper {
			width: 100%;
			height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
		}
		.lightbox-content {
			max-width: 90%;
			max-height: 85vh;
			object-fit: contain;
			user-select: none;
			pointer-events: auto;
			transform-origin: center center;
			transform: scale(0.9);
			transition: transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
		}
		.lightbox.show .lightbox-content {
			transform: scale(1);
		}

		@media (max-width: 900px) {
			h1 {
				font-size: 1.4rem;
			}
			.hero {
				padding: 1.5rem 1rem;
				flex-direction: column;
				gap: 1rem;
			}
			.header-nav {
				position: static;
				justify-content: center;
				gap: 2rem;
				width: 100%;
			}
			.landing-content {
				position: absolute !important;
				top: 55% !important;
				left: 50% !important;
				transform: translate(-50%, -50%) !important;
				width: 100%;
			}
			.zoom-img:hover {
				transform: scale(1);
			}
			.playback-status {
				top: 160px;
				left: 1.5rem;
			}
			.audio-controls-group {
				top: 160px;
				right: 1.5rem;
			}
			.volume-slider-wrapper {
				display: none !important;
			}
		}
	</style>

	<script>
		const v1 = document.getElementById("bg-video-1") as HTMLVideoElement;
		const v2 = document.getElementById("bg-video-2") as HTMLVideoElement;
		const v3 = document.getElementById("bg-video-3") as HTMLVideoElement;
		const videos = [v1, v2, v3];

		const landingCard = document.getElementById("landing-trigger");
		const scrollFade = document.getElementById("scroll-fade");
		const mainContent = document.getElementById(
			"scroll-container",
		) as HTMLElement;
		const landingText = document.getElementById("landing-text-wrapper");
		const videoWrapper = document.getElementById("video-wrapper");
		const playbackStatus = document.getElementById("playback-status");

		const audioControlsGroup = document.querySelector(
			".audio-controls-group",
		);
		const audioToggle = document.getElementById("audio-toggle");
		const volumeSlider = document.getElementById(
			"volume-slider",
		) as HTMLInputElement;

		const bgMusic = document.getElementById("bg-music") as HTMLAudioElement;
		const lightbox = document.getElementById("lightbox") as HTMLElement;
		const lightboxImg = document.getElementById(
			"lightbox-img",
		) as HTMLImageElement;
		const closeBtn = document.getElementById("close-btn");

		let currentIndex = 0;
		let isTransitioning = false;
		let isUserPaused = false; // Flag to track if the user intentionally paused the video

		let initialPinchDistance = 0;
		let isPinching = false;
		let lastTapTime = 0;
		let isDoubleTapZoomed = false;

		function getDistance(touches: TouchList) {
			const dx = touches[0].clientX - touches[1].clientX;
			const dy = touches[0].clientY - touches[1].clientY;
			return Math.sqrt(dx * dx + dy * dy);
		}

		function getPinchCenter(touches: TouchList, element: HTMLElement) {
			const rect = element.getBoundingClientRect();
			const centerX = (touches[0].clientX + touches[1].clientX) / 2;
			const centerY = (touches[0].clientY + touches[1].clientY) / 2;
			return `${((centerX - rect.left) / rect.width) * 100}% ${((centerY - rect.top) / rect.height) * 100}%`;
		}

		function getSingleTapCenter(touch: Touch, element: HTMLElement) {
			const rect = element.getBoundingClientRect();
			return `${((touch.clientX - rect.left) / rect.width) * 100}% ${((touch.clientY - rect.top) / rect.height) * 100}%`;
		}

		const updateUI = () => {
			const currentVideo = videos[currentIndex];
			if (playbackStatus) {
				currentVideo.paused
					? playbackStatus.classList.add("is-paused")
					: playbackStatus.classList.remove("is-paused");
			}
			if (currentIndex === 1) {
				landingText?.classList.add("is-dark");
				playbackStatus?.classList.add("is-dark");
				audioControlsGroup?.classList.add("is-dark");
			} else {
				landingText?.classList.remove("is-dark");
				playbackStatus?.classList.remove("is-dark");
				audioControlsGroup?.classList.remove("is-dark");
			}
		};

		const toggleMusic = () => {
			if (!bgMusic) return;
			if (bgMusic.paused) {
				bgMusic.play();
				audioToggle?.classList.add("is-playing");
			} else {
				bgMusic.pause();
				audioToggle?.classList.remove("is-playing");
			}
		};

		if (audioToggle)
			audioToggle.addEventListener("click", (e) => {
				e.stopPropagation();
				toggleMusic();
			});

		if (volumeSlider && bgMusic) {
			volumeSlider.addEventListener("input", (e) => {
				const val = parseFloat((e.target as HTMLInputElement).value);
				bgMusic.volume = val;
			});
			volumeSlider.addEventListener("click", (e) => e.stopPropagation());
		}

		// ... existing variable declarations (v1, v2, v3, etc.)
		function showLanding() {
			// 1. Prepare all videos immediately (Keeps your iPhone fix)
			videos.forEach((v) => {
				v.muted = true;
				v.preload = "auto";
				v.load();
			});

			// 2. Attempt to play the first video
			v1.play()
				.catch((err) => {
					console.warn("Autoplay blocked or failed:", err);
				})
				.finally(() => {
					// 3. Reveal everything at once only when the play command is processed
					// This prevents the text from appearing before the video container is ready
					videoWrapper?.classList.add("is-visible");
					landingText?.classList.add("is-visible");
					updateUI();
				});
		}

		if (v1) {
			v1.addEventListener("playing", showLanding, { once: true });
			if (v1.readyState >= 3) showLanding();
		}

		function triggerCyberSwap() {
			if (isTransitioning) return;
			isTransitioning = true;

			const oldVideo = videos[currentIndex];
			const nextIndex = (currentIndex + 1) % videos.length;
			const newVideo = videos[nextIndex];

			// 1. Start the visual glitch
			oldVideo.classList.add("video-glitch");
			landingText?.classList.add("text-glitch");

			// 2. Prepare the new video BEFORE the swap
			newVideo.currentTime = 0;

			// 3. Chain the play promise to prevent the "pause-freeze" bug
			const playPromise = newVideo.play();

			if (playPromise !== undefined) {
				playPromise
					.then(() => {
						// Only swap once we are sure the new video is actually playing
						setTimeout(() => {
							oldVideo.classList.remove("is-active");
							oldVideo.pause();

							currentIndex = nextIndex;
							newVideo.classList.add("is-active");
							newVideo.classList.add("video-glitch");
							updateUI();
						}, 80);
					})
					.catch((error) => {
						console.error("Auto-play failed:", error);
						// Fallback: Swap anyway so the site doesn't break
						isTransitioning = false;
					});
			}

			// 4. Clean up glitch effects
			setTimeout(() => {
				videos.forEach((v) => v.classList.remove("video-glitch"));
				landingText?.classList.remove("text-glitch");
				isTransitioning = false;
			}, 350); // Slightly longer to cover the load time
		}
		function attemptGlitch() {
			const scrollPos = mainContent.scrollTop;
			const activeVideo = videos[currentIndex];

			if (
				scrollPos > window.innerHeight * 0.5 ||
				activeVideo.paused ||
				isTransitioning
			) {
				setTimeout(attemptGlitch, 1000);
				return;
			}

			if (Math.random() < 0.08) {
				// Pick a random text glitch type
				const glitchTypes = [
					"text-glitch",
					"text-glitch-h",
					"text-glitch-v",
					"text-glitch-color",
				];
				const randomType =
					glitchTypes[Math.floor(Math.random() * glitchTypes.length)];

				activeVideo.classList.add("video-glitch");
				landingText?.classList.add(randomType);

				const duration = Math.random() * 150 + 50;

				setTimeout(() => {
					activeVideo.classList.remove("video-glitch");
					glitchTypes.forEach((t) =>
						landingText?.classList.remove(t),
					);

					if (Math.random() < 0.08) {
						setTimeout(attemptGlitch, 40);
					} else {
						setTimeout(attemptGlitch, Math.random() * 4000 + 1000);
					}
				}, duration);
			} else {
				setTimeout(attemptGlitch, 500);
			}
		}

		attemptGlitch();

		videos.forEach((v) => {
			v.addEventListener("play", updateUI);
			v.addEventListener("pause", updateUI);
			v.addEventListener("timeupdate", () => {
				if (
					v.classList.contains("is-active") &&
					v.currentTime > v.duration - 0.3 &&
					!isTransitioning
				) {
					triggerCyberSwap();
				}
			});
		});

		const closeLightbox = () => {
			lightbox.classList.remove("show");
			document.body.style.overflow = "auto";
			isDoubleTapZoomed = false;
		};

		document.querySelectorAll(".zoom-img").forEach((img) => {
			img.addEventListener("click", () => {
				lightboxImg.src = (img as HTMLImageElement).src;
				lightboxImg.style.transform = "scale(1)";
				lightboxImg.style.transformOrigin = "center center";
				isDoubleTapZoomed = false;
				lightbox.classList.add("show");
				document.body.style.overflow = "hidden";
			});
		});

		closeBtn?.addEventListener("click", (e) => {
			e.stopPropagation();
			closeLightbox();
		});

		lightbox.addEventListener(
			"touchstart",
			(e) => {
				if (e.touches.length === 1) {
					const now = Date.now();
					const timesince = now - lastTapTime;
					if (timesince < 300 && timesince > 0) {
						e.preventDefault();
						if (!isDoubleTapZoomed) {
							lightboxImg.style.transformOrigin =
								getSingleTapCenter(e.touches[0], lightboxImg);
							lightboxImg.style.transition =
								"transform 0.3s ease";
							lightboxImg.style.transform = "scale(2.5)";
							isDoubleTapZoomed = true;
						} else {
							lightboxImg.style.transition =
								"transform 0.3s ease";
							lightboxImg.style.transform = "scale(1)";
							isDoubleTapZoomed = false;
						}
						return;
					}
					lastTapTime = now;
				}
				if (e.touches.length === 2) {
					isPinching = true;
					initialPinchDistance = getDistance(e.touches);
					lightboxImg.style.transformOrigin = getPinchCenter(
						e.touches,
						lightboxImg,
					);
				}
			},
			{ passive: false },
		);

		lightbox.addEventListener(
			"touchmove",
			(e) => {
				if (isPinching && e.touches.length === 2) {
					e.preventDefault();
					const scale = getDistance(e.touches) / initialPinchDistance;
					lightboxImg.style.transform = `scale(${scale})`;
					lightboxImg.style.transition = "none";
				}
			},
			{ passive: false },
		);

		lightbox.addEventListener("touchend", (e) => {
			if (isPinching && e.touches.length < 2) {
				isPinching = false;
				lightboxImg.style.transition =
					"transform 0.3s ease, transform-origin 0.3s ease";
				lightboxImg.style.transform = "scale(1)";
				isDoubleTapZoomed = false;
				setTimeout(() => {
					lightboxImg.style.transformOrigin = "center center";
				}, 300);
			}
		});

		lightbox.addEventListener("click", (e) => {
			if (
				e.target === lightbox ||
				(e.target as HTMLElement).id === "lightbox-wrapper"
			)
				closeLightbox();
		});

		if (playbackStatus) {
			playbackStatus.addEventListener("click", (e) => {
				e.stopPropagation();
				const activeVideo = videos[currentIndex];
				if (activeVideo.paused) {
					isUserPaused = false;
					activeVideo.play();
				} else {
					isUserPaused = true;
					activeVideo.pause();
				}
			});
		}

		if (landingCard) {
			landingCard.addEventListener("click", () => {
				const activeVideo = videos[currentIndex];
				if (activeVideo.paused) {
					isUserPaused = false;
					activeVideo.play();
				} else {
					isUserPaused = true;
					activeVideo.pause();
				}
			});
		}

		const triggerBackToTop = () => {
			mainContent.style.scrollSnapType = "none";
			const start = mainContent.scrollTop;
			const duration = 4000;
			const startTime = performance.now();

			function easeOutQuart(x: number): number {
				return 1 - Math.pow(1 - x, 4);
			}

			function animate(currentTime: number) {
				const elapsed = currentTime - startTime;
				const progress = Math.min(elapsed / duration, 1);
				const easedProgress = easeOutQuart(progress);
				mainContent.scrollTop = start * (1 - easedProgress);

				if (progress < 1) {
					window.requestAnimationFrame(animate);
				} else {
					mainContent.style.scrollSnapType = "y mandatory";
				}
			}
			window.requestAnimationFrame(animate);
		};

		// FIXED: Intersection Observer specifically observing the scroll container
		if (landingCard && mainContent) {
			const observer = new IntersectionObserver(
				(entries) => {
					entries.forEach((entry) => {
						const activeVideo = videos[currentIndex];
						if (entry.isIntersecting) {
							// Only play if the user hasn't explicitly paused it
							if (!isUserPaused) {
								activeVideo.play().catch(() => {});
							}
						} else {
							// Card is out of view, pause for performance
							activeVideo.pause();
						}
					});
				},
				{
					root: mainContent, // Use the scroll container as the reference root
					threshold: 0.1,
				},
			);

			observer.observe(landingCard);
		}

		document.querySelectorAll(".scroll-trigger").forEach((trigger) => {
			trigger.addEventListener("click", (e) => {
				e.stopPropagation();
				document
					.querySelector(".first-hero")
					?.scrollIntoView({ behavior: "smooth", block: "start" });
			});
		});

		window.addEventListener("keydown", (e) => {
			if (e.key.toLowerCase() === "m") {
				toggleMusic();
			}
			if (
				e.key === "Escape" ||
				(e.key.toLowerCase() === "f" &&
					lightbox.classList.contains("show"))
			) {
				if (lightbox.classList.contains("show")) {
					closeLightbox();
					return;
				}
			}
			if (
				e.key.toLowerCase() === "f" &&
				!lightbox.classList.contains("show")
			) {
				const cards = Array.from(
					document.querySelectorAll(".project-card"),
				);
				const activeCard = cards.find((card) => {
					const rect = card.getBoundingClientRect();
					return (
						rect.top >= -window.innerHeight / 2 &&
						rect.top <= window.innerHeight / 2
					);
				});
				const targetImg = activeCard?.querySelector(
					".zoom-img",
				) as HTMLImageElement;
				if (targetImg) {
					lightboxImg.src = targetImg.src;
					lightboxImg.style.transform = "scale(1)";
					lightboxImg.style.transformOrigin = "center center";
					isDoubleTapZoomed = false;
					lightbox.classList.add("show");
					document.body.style.overflow = "hidden";
				}
			}
			if (
				["ArrowUp", "ArrowDown", " "].includes(e.key) &&
				!lightbox.classList.contains("show")
			) {
				e.preventDefault();
				const cards = Array.from(
					document.querySelectorAll(".project-card"),
				);
				let currentIdx = cards.findIndex((card) => {
					const rect = card.getBoundingClientRect();
					return (
						rect.top >= -window.innerHeight / 2 &&
						rect.top <= window.innerHeight / 2
					);
				});
				if (e.key === "ArrowDown" || e.key === " ") {
					if (currentIdx < cards.length - 1) {
						cards[currentIdx + 1].scrollIntoView({
							behavior: "smooth",
							block: "start",
						});
					} else if (e.key === " ") {
						triggerBackToTop();
					}
				} else if (e.key === "ArrowUp") {
					if (currentIdx > 0) {
						cards[currentIdx - 1].scrollIntoView({
							behavior: "smooth",
							block: "start",
						});
					}
				}
			}
		});

		if (mainContent && scrollFade && landingText) {
			mainContent.addEventListener("scroll", () => {
				const scrollPos = mainContent.scrollTop;
				const progress = Math.min(
					scrollPos / (window.innerHeight * 0.8),
					1,
				);
				scrollFade.style.opacity = progress.toString();
				landingText.style.opacity = (1 - progress * 1.5).toString();
				if (playbackStatus)
					playbackStatus.style.opacity = (
						0.5 *
						(1 - progress * 2)
					).toString();
				if (audioControlsGroup)
					(audioControlsGroup as HTMLElement).style.opacity = (
						0.5 *
						(1 - progress * 2)
					).toString();
			});
		}

		document
			.getElementById("back-to-top")
			?.addEventListener("click", triggerBackToTop);
	</script>
</Layout>
